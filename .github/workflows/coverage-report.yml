name: Coverage Report

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'tests/**'
      - '*.sln'
      - '*.csproj'
      - 'coverlet.runsettings'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Restore tools
        run: dotnet tool restore

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Install jq for JSON parsing
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Install diff-cover
        run: pip install diff-cover

      - name: Restore dependencies
        run: dotnet restore ProbotSharp.sln

      - name: Build in Debug for Coverage
        run: dotnet build ProbotSharp.sln --configuration Debug --no-restore

      # Run coverage for current PR (Debug mode for accurate instrumentation)
      - name: Run tests with coverage (PR)
        run: |
          dotnet test ProbotSharp.sln \
            --configuration Debug \
            --no-build \
            --collect:"XPlat Code Coverage" \
            --settings coverlet.runsettings \
            --results-directory ./coverage-pr

      - name: Generate PR Coverage Report
        run: |
          reportgenerator \
            "-reports:coverage-pr/**/coverage.cobertura.xml" \
            "-targetdir:coverage-report-pr" \
            "-reporttypes:Html;Cobertura;TextSummary;JsonSummary;Badges;MarkdownSummary" \
            "-assemblyfilters:+ProbotSharp.*;-*.Tests;-*.Tests.*" \
            "-classfilters:+*;-*Migrations*;-*DbContextModelSnapshot" \
            "-title:ProbotSharp Coverage Report (PR)"

      - name: Generate Merged Cobertura for Diff Analysis
        run: |
          reportgenerator \
            "-reports:coverage-pr/**/coverage.cobertura.xml" \
            "-targetdir:coverage-merged" \
            "-reporttypes:Cobertura" \
            "-assemblyfilters:+ProbotSharp.*;-*.Tests;-*.Tests.*" \
            "-classfilters:+*;-*Migrations*;-*DbContextModelSnapshot"

      # Checkout base branch for comparison
      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Restore base branch
        run: dotnet restore ProbotSharp.sln

      - name: Build base branch in Debug for Coverage
        run: dotnet build ProbotSharp.sln --configuration Debug --no-restore

      # Run coverage for base branch (Debug mode for accurate instrumentation)
      - name: Run tests with coverage (Base)
        run: |
          dotnet test ProbotSharp.sln \
            --configuration Debug \
            --no-build \
            --collect:"XPlat Code Coverage" \
            --settings coverlet.runsettings \
            --results-directory ./coverage-base
        continue-on-error: true

      - name: Generate Base Coverage Report
        run: |
          reportgenerator \
            "-reports:coverage-base/**/coverage.cobertura.xml" \
            "-targetdir:coverage-report-base" \
            "-reporttypes:JsonSummary" \
            "-assemblyfilters:+ProbotSharp.*;-*.Tests;-*.Tests.*" \
            "-classfilters:+*;-*Migrations*;-*DbContextModelSnapshot"
        continue-on-error: true

      - name: Upload Summary.json for debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary-json-debug-${{ github.event.pull_request.number }}
          path: |
            coverage-report-pr/Summary.json
            coverage-report-base/Summary.json
          retention-days: 7

      # Compare and generate PR comment
      - name: Generate Coverage Comparison
        id: coverage_comparison
        run: |
          # Extract PR coverage using jq for reliable JSON parsing
          # ReportGenerator's Summary.json has coverage metrics nested under .summary object
          # Values are stored as percentages (0-100), not decimal rates (0.0-1.0)
          if [ -f coverage-report-pr/Summary.json ]; then
            echo "::debug::PR Summary.json structure:"
            jq '.summary | {linecoverage, branchcoverage, methodcoverage}' coverage-report-pr/Summary.json || echo "::warning::Failed to parse PR JSON"

            # Extract coverage values from .summary object
            PR_LINE=$(jq -r '.summary.linecoverage // 0' coverage-report-pr/Summary.json 2>/dev/null)
            PR_BRANCH=$(jq -r '.summary.branchcoverage // 0' coverage-report-pr/Summary.json 2>/dev/null)
            PR_METHOD=$(jq -r '.summary.methodcoverage // 0' coverage-report-pr/Summary.json 2>/dev/null)

            # Validate extracted values
            if [ -z "$PR_LINE" ] || [ "$PR_LINE" = "null" ]; then
              echo "::error::Failed to extract PR line coverage from Summary.json"
              echo "::error::Available keys: $(jq 'keys' coverage-report-pr/Summary.json 2>/dev/null)"
              PR_LINE="0"
            fi

            echo "::notice::PR Coverage - Line: ${PR_LINE}%, Branch: ${PR_BRANCH}%, Method: ${PR_METHOD}%"
          else
            echo "::error::PR coverage report not found at coverage-report-pr/Summary.json"
            PR_LINE="0"
            PR_BRANCH="0"
            PR_METHOD="0"
          fi

          # Extract base coverage with same approach
          if [ -f coverage-report-base/Summary.json ]; then
            echo "::debug::Base Summary.json structure:"
            jq '.summary | {linecoverage, branchcoverage, methodcoverage}' coverage-report-base/Summary.json || echo "::warning::Failed to parse base JSON"

            BASE_LINE=$(jq -r '.summary.linecoverage // 0' coverage-report-base/Summary.json 2>/dev/null)
            BASE_BRANCH=$(jq -r '.summary.branchcoverage // 0' coverage-report-base/Summary.json 2>/dev/null)
            BASE_METHOD=$(jq -r '.summary.methodcoverage // 0' coverage-report-base/Summary.json 2>/dev/null)

            if [ -z "$BASE_LINE" ] || [ "$BASE_LINE" = "null" ]; then
              echo "::error::Failed to extract base line coverage from Summary.json"
              echo "::error::Available keys: $(jq 'keys' coverage-report-base/Summary.json 2>/dev/null)"
              BASE_LINE="0"
            fi

            echo "::notice::Base Coverage - Line: ${BASE_LINE}%, Branch: ${BASE_BRANCH}%, Method: ${BASE_METHOD}%"
          else
            echo "::error::Base branch coverage report not found - cannot compare"
            BASE_LINE="0"
            BASE_BRANCH="0"
            BASE_METHOD="0"
          fi

          # Calculate deltas
          LINE_DELTA=$(echo "$PR_LINE - $BASE_LINE" | bc)
          BRANCH_DELTA=$(echo "$PR_BRANCH - $BASE_BRANCH" | bc)
          METHOD_DELTA=$(echo "$PR_METHOD - $BASE_METHOD" | bc)

          # Format deltas with sign
          if (( $(echo "$LINE_DELTA > 0" | bc -l) )); then
            LINE_DELTA_STR="+${LINE_DELTA}%"
            LINE_EMOJI="📈"
          elif (( $(echo "$LINE_DELTA < 0" | bc -l) )); then
            LINE_DELTA_STR="${LINE_DELTA}%"
            LINE_EMOJI="📉"
          else
            LINE_DELTA_STR="0%"
            LINE_EMOJI="➡️"
          fi

          if (( $(echo "$BRANCH_DELTA > 0" | bc -l) )); then
            BRANCH_DELTA_STR="+${BRANCH_DELTA}%"
            BRANCH_EMOJI="📈"
          elif (( $(echo "$BRANCH_DELTA < 0" | bc -l) )); then
            BRANCH_DELTA_STR="${BRANCH_DELTA}%"
            BRANCH_EMOJI="📉"
          else
            BRANCH_DELTA_STR="0%"
            BRANCH_EMOJI="➡️"
          fi

          # Save values for next steps
          echo "pr_line=${PR_LINE}" >> $GITHUB_OUTPUT
          echo "pr_branch=${PR_BRANCH}" >> $GITHUB_OUTPUT
          echo "base_line=${BASE_LINE}" >> $GITHUB_OUTPUT
          echo "base_branch=${BASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "line_delta=${LINE_DELTA_STR}" >> $GITHUB_OUTPUT
          echo "branch_delta=${BRANCH_DELTA_STR}" >> $GITHUB_OUTPUT
          echo "line_emoji=${LINE_EMOJI}" >> $GITHUB_OUTPUT
          echo "branch_emoji=${BRANCH_EMOJI}" >> $GITHUB_OUTPUT

          # Define minimum thresholds
          MIN_LINE_COVERAGE=80
          MIN_BRANCH_COVERAGE=75

          # Informational project-wide status - does NOT block, only for display
          if (( $(echo "$PR_LINE < $MIN_LINE_COVERAGE" | bc -l) )) || (( $(echo "$PR_BRANCH < $MIN_BRANCH_COVERAGE" | bc -l) )); then
            echo "project_status=below_target" >> $GITHUB_OUTPUT
            echo "project_status_msg=⚠️ Project-wide coverage below targets (${MIN_LINE_COVERAGE}% line, ${MIN_BRANCH_COVERAGE}% branch)" >> $GITHUB_OUTPUT
            echo "project_emoji=⚠️" >> $GITHUB_OUTPUT
          elif (( $(echo "$LINE_DELTA < -5" | bc -l) )) || (( $(echo "$BRANCH_DELTA < -5" | bc -l) )); then
            echo "project_status=significant_decrease" >> $GITHUB_OUTPUT
            echo "project_status_msg=📉 Significant coverage decrease detected" >> $GITHUB_OUTPUT
            echo "project_emoji=📉" >> $GITHUB_OUTPUT
          elif (( $(echo "$LINE_DELTA < 0" | bc -l) )) || (( $(echo "$BRANCH_DELTA < 0" | bc -l) )); then
            echo "project_status=slight_decrease" >> $GITHUB_OUTPUT
            echo "project_status_msg=➖ Coverage decreased slightly" >> $GITHUB_OUTPUT
            echo "project_emoji=➖" >> $GITHUB_OUTPUT
          elif (( $(echo "$LINE_DELTA > 0" | bc -l) )) && (( $(echo "$BRANCH_DELTA > 0" | bc -l) )); then
            echo "project_status=improved" >> $GITHUB_OUTPUT
            echo "project_status_msg=📈 Coverage improved!" >> $GITHUB_OUTPUT
            echo "project_emoji=📈" >> $GITHUB_OUTPUT
          else
            echo "project_status=stable" >> $GITHUB_OUTPUT
            echo "project_status_msg=➡️ Coverage stable" >> $GITHUB_OUTPUT
            echo "project_emoji=➡️" >> $GITHUB_OUTPUT
          fi

      - name: Analyze PR Diff Coverage
        id: diff_coverage
        run: |
          # Run diff-cover against base branch to get coverage of changed lines only
          diff-cover coverage-merged/Cobertura.xml \
            --compare-branch=origin/${{ github.base_ref }} \
            --json-report coverage-diff.json \
            --html-report coverage-diff.html || true

          # Extract diff coverage metrics (only changed lines)
          if [ -f coverage-diff.json ]; then
            DIFF_LINE=$(jq -r '.totals.line_coverage // 0' coverage-diff.json)
            DIFF_BRANCH=$(jq -r '.totals.branch_coverage // 0' coverage-diff.json)
            DIFF_LINES_CHANGED=$(jq -r '.totals.num_changed_lines // 0' coverage-diff.json)
            DIFF_LINES_COVERED=$(jq -r '.totals.num_covered_lines // 0' coverage-diff.json)
          else
            echo "::warning::Failed to generate diff coverage, will skip diff check"
            DIFF_LINE="N/A"
            DIFF_BRANCH="N/A"
            DIFF_LINES_CHANGED="0"
            DIFF_LINES_COVERED="0"
          fi

          echo "diff_line=${DIFF_LINE}" >> $GITHUB_OUTPUT
          echo "diff_branch=${DIFF_BRANCH}" >> $GITHUB_OUTPUT
          echo "diff_lines_changed=${DIFF_LINES_CHANGED}" >> $GITHUB_OUTPUT
          echo "diff_lines_covered=${DIFF_LINES_COVERED}" >> $GITHUB_OUTPUT

          # Determine diff coverage status (this is what blocks)
          MIN_DIFF_LINE=80
          MIN_DIFF_BRANCH=75

          if [ "$DIFF_LINE" = "N/A" ]; then
            echo "diff_status=warning" >> $GITHUB_OUTPUT
            echo "diff_status_msg=⚠️ Unable to calculate diff coverage" >> $GITHUB_OUTPUT
          elif [ "$DIFF_LINES_CHANGED" = "0" ]; then
            echo "diff_status=success" >> $GITHUB_OUTPUT
            echo "diff_status_msg=ℹ️ No code changes detected" >> $GITHUB_OUTPUT
          elif (( $(echo "$DIFF_LINE < $MIN_DIFF_LINE" | bc -l) )); then
            echo "diff_status=failure" >> $GITHUB_OUTPUT
            echo "diff_status_msg=❌ Changed lines coverage below ${MIN_DIFF_LINE}% threshold" >> $GITHUB_OUTPUT
          elif (( $(echo "$DIFF_BRANCH < $MIN_DIFF_BRANCH" | bc -l) )); then
            echo "diff_status=failure" >> $GITHUB_OUTPUT
            echo "diff_status_msg=❌ Changed branches coverage below ${MIN_DIFF_BRANCH}% threshold" >> $GITHUB_OUTPUT
          else
            echo "diff_status=success" >> $GITHUB_OUTPUT
            echo "diff_status_msg=✅ Changed code meets coverage requirements" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Coverage
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ## 📊 Coverage Report

            ### ${{ steps.diff_coverage.outputs.diff_status_msg }}

            **PR Diff Coverage** (Changed lines only - **blocks merge**):

            | Metric | Changed Lines Coverage | Threshold | Status |
            |--------|----------------------|-----------|--------|
            | **Line Coverage** | **${{ steps.diff_coverage.outputs.diff_line }}%** | 80% | ${{ steps.diff_coverage.outputs.diff_line >= 80 && '✅ Pass' || steps.diff_coverage.outputs.diff_line == 'N/A' && 'ℹ️ N/A' || '❌ Fail' }} |
            | **Branch Coverage** | **${{ steps.diff_coverage.outputs.diff_branch }}%** | 75% | ${{ steps.diff_coverage.outputs.diff_branch >= 75 && '✅ Pass' || steps.diff_coverage.outputs.diff_branch == 'N/A' && 'ℹ️ N/A' || '❌ Fail' }} |

            <sub>📝 Changed: ${{ steps.diff_coverage.outputs.diff_lines_covered }}/${{ steps.diff_coverage.outputs.diff_lines_changed }} lines covered</sub>

            ---

            ### Project-Wide Coverage (informational only)

            ${{ steps.coverage_comparison.outputs.project_emoji }} ${{ steps.coverage_comparison.outputs.project_status_msg }}

            | Metric | Base Branch | This PR | Delta | Target |
            |--------|-------------|---------|-------|--------|
            | **Line Coverage** | ${{ steps.coverage_comparison.outputs.base_line }}% | ${{ steps.coverage_comparison.outputs.pr_line }}% | ${{ steps.coverage_comparison.outputs.line_emoji }} ${{ steps.coverage_comparison.outputs.line_delta }} | 80% |
            | **Branch Coverage** | ${{ steps.coverage_comparison.outputs.base_branch }}% | ${{ steps.coverage_comparison.outputs.pr_branch }}% | ${{ steps.coverage_comparison.outputs.branch_emoji }} ${{ steps.coverage_comparison.outputs.branch_delta }} | 75% |

            <details>
            <summary>📋 Coverage Targets by Layer</summary>

            - **Domain Layer**: 90% line, 85% branch
            - **Application Layer**: 80% line, 75% branch
            - **Infrastructure Layer**: 70% line, 65% branch
            - **Overall Target**: 80% line, 75% branch

            ℹ️ These are aspirational targets. Only **PR Diff Coverage** blocks merges.

            </details>

            ---
            *Coverage analysis by [diff-cover](https://github.com/Bachmann1234/diff_cover) | [Full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*

      - name: Upload PR Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-pr-${{ github.event.pull_request.number }}
          path: coverage-report-pr/
          retention-days: 30

      - name: Upload Diff Coverage HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-diff-html-pr-${{ github.event.pull_request.number }}
          path: coverage-diff.html
          retention-days: 30

      - name: Set Coverage Status Check
        if: always()
        run: |
          DIFF_STATUS="${{ steps.diff_coverage.outputs.diff_status }}"
          DIFF_LINE="${{ steps.diff_coverage.outputs.diff_line }}"
          DIFF_BRANCH="${{ steps.diff_coverage.outputs.diff_branch }}"
          PROJECT_STATUS="${{ steps.coverage_comparison.outputs.project_status }}"

          echo "=== Coverage Gate Results ==="
          echo "PR Diff Coverage (BLOCKING): ${DIFF_STATUS}"
          echo "  - Line: ${DIFF_LINE}% (min: 80%)"
          echo "  - Branch: ${DIFF_BRANCH}% (min: 75%)"
          echo ""
          echo "Project-Wide Status (INFORMATIONAL): ${PROJECT_STATUS}"
          echo ""

          # Only block based on diff coverage
          if [ "$DIFF_STATUS" = "failure" ]; then
            echo "::error::PR diff coverage check failed. Changed lines coverage: Line ${DIFF_LINE}%, Branch ${DIFF_BRANCH}%"
            echo "::error::Your changed code must have at least 80% line coverage and 75% branch coverage."
            exit 1
          elif [ "$DIFF_STATUS" = "warning" ]; then
            echo "::warning::Unable to calculate diff coverage - manual review recommended"
          else
            echo "::notice::PR diff coverage check passed! Line: ${DIFF_LINE}%, Branch: ${DIFF_BRANCH}%"
          fi

          # Show project-wide status as informational notice
          case "$PROJECT_STATUS" in
            below_target)
              echo "::notice::Project-wide coverage is below targets but this does not block the PR"
              ;;
            significant_decrease)
              echo "::warning::Project-wide coverage decreased significantly - consider adding more tests"
              ;;
            improved)
              echo "::notice::Great job! Project-wide coverage improved 🎉"
              ;;
          esac

          # Verify base report exists (sanity check)
          if [ ! -f coverage-report-base/Summary.json ]; then
            echo "::warning::Base branch coverage report not found - diff comparison may be incomplete"
          fi